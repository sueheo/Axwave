<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>서울 기상 관측 대시보드</title>

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.min.css" />

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        /* Pretendard 폰트 적용 */
        body {
            font-family: 'Pretendard', sans-serif;
        }
        /* Leaflet 지도 컨테이너 높이 설정 */
        #map {
            height: 600px;
            width: 100%;
        }
        /* 로딩 중 지도 영역 숨기기 */
        .hidden-map {
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 border-b pb-2">
            서울 기상 관측 대시보드 ⛅ (순수 HTML/JS)
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <div id="dashboard-card" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-min">
                <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.976 5.002 5.002 0 10-9.721-2.784A4.004 4.004 0 003 15z" />
                    </svg>
                    최신 관측 데이터 (서울)
                </h2>
                <div id="data-display" class="space-y-4">
                    <div id="loading-spinner" class="flex justify-center items-center py-10">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                        <span class="ml-3 text-gray-500">데이터 로딩 중...</span>
                    </div>

                    </div>
            </div>

            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-2">
                <div id="map" class="rounded-lg hidden-map"></div>
            </div>

        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ====================================================================
        // 1. Supabase 및 API 설정
        // ====================================================================
        const SUPABASE_HOST = 'https://nmutttcelavvmoxfshql.supabase.co';
        
        // Anon Key (Public Key)
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5tdXR0dGNlbGF2dm1veGZzaHFsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NDY3MzYsImV4cCI6MjA3NjAyMjczNn0.rTuB-Y2_cFGQQR3W3aDaJbHgAFDDGyKRvUpMAa2DwKo';

        const TABLE_NAME = 'kma_observation_data';
        const API_URL = `${SUPABASE_HOST}/rest/v1/${TABLE_NAME}`;

        // 서울 관측 지점 (STN 108) 좌표
        const SEOUL_LAT = 37.5709;
        const SEOUL_LON = 126.9754;
        const SEOUL_COORDS = [SEOUL_LAT, SEOUL_LON];

        // Leaflet 아이콘 경로 설정 (CDN 사용 시 필수)
        L.Icon.Default.imagePath = 'https://unpkg.com/leaflet@1.9.4/dist/images/';

        // ====================================================================
        // 2. 유틸리티 함수
        // ====================================================================

        // TM 데이터 포맷팅 함수 (ISO 8601 -> YYYY.MM.DD HH:MM)
        const formatTM = (tm) => {
            if (!tm) return 'N/A';
            try {
                const date = new Date(tm);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hour = String(date.getHours()).padStart(2, '0');
                const minute = String(date.getMinutes()).padStart(2, '0');
                return `${year}.${month}.${day} ${hour}:${minute}`;
            } catch (e) {
                return 'N/A';
            }
        };

        // 데이터 카드 HTML 생성 함수
        const createDataCardHTML = (iconSVG, label, value, unit, color) => `
            <div class="flex items-center p-3 bg-white rounded-lg shadow-md border border-gray-100 transition duration-300 hover:shadow-lg">
                <div class="p-3 rounded-full ${color} text-white mr-4 flex-shrink-0">
                    ${iconSVG}
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-500">${label}</p>
                    <p class="text-2xl font-semibold text-gray-800">
                        ${value}
                        <span class="text-base font-normal ml-1">${unit}</span>
                    </p>
                </div>
            </div>
        `;

        // ====================================================================
        // 3. 주요 로직 함수
        // ====================================================================

        async function fetchWeatherData() {
            const dataDisplay = document.getElementById('data-display');
            const mapContainer = document.getElementById('map');
            const spinner = document.getElementById('loading-spinner');
            
            if (spinner) spinner.style.display = 'flex';
            dataDisplay.innerHTML = ''; 

            try {
                // Supabase PostgREST API 호출
                const response = await fetch(`${API_URL}?order=tm.desc&limit=1`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`, 
                    },
                });

                if (!response.ok) {
                    // API 응답 코드를 포함하여 에러 메시지 출력
                    throw new Error(`HTTP Error! Status: ${response.status}. 인증 또는 RLS 문제일 수 있습니다.`);
                }

                const data = await response.json();

                if (data && data.length > 0) {
                    const latestData = data[0];
                    renderDashboard(latestData);
                    renderMap(latestData);
                } else {
                    dataDisplay.innerHTML = '<p class="text-red-600 font-semibold">데이터를 찾을 수 없습니다. DB에 관측 데이터가 있는지 확인하세요.</p>';
                }

            } catch (error) {
                console.error("데이터 로딩 중 오류 발생:", error);
                dataDisplay.innerHTML = `<p class="text-red-600 font-semibold">❌ 오류 발생: ${error.message}</p>`;
            } finally {
                if (spinner) spinner.style.display = 'none';
            }
        }

        function renderDashboard(data) {
            const dataDisplay = document.getElementById('data-display');
            const { tm, ta, hm, ws, ps, wd, ca_tot, stn } = data; 
            const formattedTime = formatTM(tm);

            const timeInfoHTML = `
                <p class="text-base text-gray-600 mb-6 border-b pb-2">
                    <span class="font-bold text-indigo-600">최신 관측 시간:</span> ${formattedTime} (지점 번호: ${stn || 'N/A'})
                </p>
            `;
            const existingTimeInfo = document.querySelector('#dashboard-card > p.text-base.text-gray-600');
            if (existingTimeInfo) existingTimeInfo.remove();
            document.querySelector('#dashboard-card > h2').insertAdjacentHTML('afterend', timeInfoHTML);


            let cardsHTML = '';
            
            // 기온 카드
            cardsHTML += createDataCardHTML(
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`,
                "기온 (TA)",
                ta !== null && ta !== undefined ? parseFloat(ta).toFixed(1) : 'N/A',
                "°C",
                "bg-red-500"
            );

            // 습도 카드
            cardsHTML += createDataCardHTML(
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h-2m0 0l-1 9-1-9m4 0l1-9 1 9m-4 0a4 4 0 100-8 4 4 0 000 8z" /></svg>`,
                "상대 습도 (HM)",
                hm || 'N/A',
                "%",
                "bg-blue-500"
            );

            // 풍속/풍향 카드
            cardsHTML += createDataCardHTML(
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>`,
                "풍속 (WS/WD)",
                ws !== null && ws !== undefined ? parseFloat(ws).toFixed(1) : 'N/A',
                `m/s (${wd || 'N/A'}°) `,
                "bg-green-500"
            );
            
            // 해면 기압 카드
            cardsHTML += createDataCardHTML(
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-2.91 3-6.5S13.657 5.5 12 5.5 9 8.41 9 12s1.343 6.5 3 6.5z" /></svg>`,
                "해면 기압 (PS)",
                ps !== null && ps !== undefined ? parseFloat(ps).toFixed(1) : 'N/A',
                "hPa",
                "bg-yellow-500"
            );

            // 전운량 카드
             cardsHTML += createDataCardHTML(
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.976 5.002 5.002 0 10-9.721-2.784A4.004 4.004 0 003 15z" /></svg>`,
                "전운량 (CA_TOT)",
                ca_tot || 'N/A',
                "1/10",
                "bg-indigo-500"
            );

            dataDisplay.innerHTML = cardsHTML;
        }

        function renderMap(data) {
            const mapElement = document.getElementById('map');
            const { tm, ta, hm, ws } = data;
            const formattedTime = formatTM(tm);

            // 이미 초기화된 지도를 제거
            if (mapElement.hasChildNodes() && mapElement._leaflet_id !== undefined) {
                mapElement.innerHTML = '';
            }
            if (mapElement._leaflet_id !== undefined) {
                 // 이전에 생성된 지도가 있다면 제거
                const existingMap = L.DomUtil.get('map');
                if (existingMap && existingMap.map) {
                    existingMap.map.remove();
                }
                mapElement._leaflet_id = undefined;
                mapElement.innerHTML = '';
            }

            const map = L.map('map').setView(SEOUL_COORDS, 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const marker = L.marker(SEOUL_COORDS).addTo(map);
            
            const popupContent = `
                <div style="font-family: 'Pretendard', sans-serif;">
                    <h3 class="font-bold text-lg mb-1">서울 관측소 (STN 108)</h3>
                    <p class="text-sm">관측 시각: <strong>${formattedTime}</strong></p>
                    <p class="text-sm">기온: <strong>${ta !== null && ta !== undefined ? parseFloat(ta).toFixed(1) : 'N/A'}°C</strong></p>
                    <p class="text-sm">습도: <strong>${hm || 'N/A'}%</strong></p>
                    <p class="text-sm">풍속: <strong>${ws !== null && ws !== undefined ? parseFloat(ws).toFixed(1) : 'N/A'} m/s</strong></p>
                </div>
            `;
            marker.bindPopup(popupContent).openPopup();

            mapElement.classList.remove('hidden-map');
        }

        // ====================================================================
        // 4. 페이지 로드 시 실행
        // ====================================================================
        document.addEventListener('DOMContentLoaded', fetchWeatherData);
    </script>
</body>
</html>